<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Webhooks Dashboard</title>
    <style>
        body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #f6f7fb; color: #1f2933; }
        header { background: linear-gradient(120deg, #1f6feb, #0ea5e9); color: #fff; padding: 16px 24px; }
        h1 { margin: 0; font-size: 20px; }
        main { padding: 24px; max-width: 1100px; margin: 0 auto; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.05); margin-bottom: 16px; }
        .row { display: flex; flex-wrap: wrap; gap: 12px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px; }
        button { background: #0ea5e9; color: #fff; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        button.secondary { background: #111827; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; font-size: 14px; }
        th { background: #f3f4f6; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-success { background: #dcfce7; color: #166534; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .muted { color: #6b7280; font-size: 13px; }
        .actions { display: flex; gap: 8px; }
        .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
        .small { font-size: 12px; }
    </style>
</head>
<body>
<header>
    <h1>Webhooks Dashboard</h1>
</header>
<main>
    <div class="card two-col">
        <div>
            <label>API Key</label>
            <input id="apiKey" type="text" placeholder="Enter X-Api-Key" data-test-id="api-key-input" />
        </div>
        <div>
            <label>API Secret</label>
            <input id="apiSecret" type="password" placeholder="Enter X-Api-Secret" data-test-id="api-secret-input" />
        </div>
    </div>

    <div class="card two-col" data-test-id="webhook-config">
        <div>
            <label>Webhook URL</label>
            <input id="webhookUrl" type="text" placeholder="https://example.com/webhooks" data-test-id="webhook-url-input" />
            <div class="muted small">Save updates the merchant webhook_url</div>
        </div>
        <div>
            <label>Webhook Secret</label>
            <div class="flex">
                <input id="webhookSecret" type="password" readonly data-test-id="webhook-secret" />
                <button id="copySecret" type="button" data-test-id="copy-secret-button">Copy</button>
                <button id="regenSecret" type="button" class="secondary" data-test-id="regenerate-secret-button">Regenerate</button>
            </div>
        </div>
        <div class="flex">
            <button id="saveConfig" type="button" data-test-id="save-webhook-button">Save Configuration</button>
            <button id="testWebhook" type="button" class="secondary" data-test-id="test-webhook-button">Send Test Webhook</button>
        </div>
        <div class="muted" id="statusMsg"></div>
    </div>

    <div class="card" data-test-id="webhook-logs-section">
        <div class="flex" style="justify-content: space-between;">
            <div>
                <strong>Webhook Logs</strong>
                <div class="muted small">Most recent first</div>
            </div>
            <div class="flex">
                <label class="muted small">Limit</label>
                <input id="limit" type="text" value="10" style="width:60px" data-test-id="webhook-logs-limit" />
                <label class="muted small">Offset</label>
                <input id="offset" type="text" value="0" style="width:60px" data-test-id="webhook-logs-offset" />
                <button id="refreshLogs" type="button" data-test-id="refresh-logs-button">Refresh</button>
            </div>
        </div>
        <table data-test-id="webhook-logs-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Event</th>
                    <th>Status</th>
                    <th>Attempts</th>
                    <th>Last Attempt</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="logsBody" data-test-id="webhook-logs-body">
                <tr><td colspan="6" class="muted">No data yet</td></tr>
            </tbody>
        </table>
    </div>
</main>

<script>
    const $ = (id) => document.getElementById(id);
    const getHeaders = () => {
        const apiKey = $("apiKey").value.trim();
        const apiSecret = $("apiSecret").value.trim();
        return { "X-Api-Key": apiKey, "X-Api-Secret": apiSecret, "Content-Type": "application/json" };
    };
    const showStatus = (msg, isError=false) => {
        const el = $("statusMsg");
        el.textContent = msg;
        el.style.color = isError ? "#b91c1c" : "#166534";
    };

    async function saveConfig() {
        try {
            const res = await fetch('/dashboard/api/webhooks/config', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ webhook_url: $("webhookUrl").value.trim() })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.description || data.error || 'Failed');
            showStatus('Webhook URL saved');
        } catch (err) {
            showStatus(err.message, true);
        }
    }

    async function regenerateSecret() {
        try {
            const res = await fetch('/dashboard/api/webhooks/secret/regenerate', {
                method: 'POST',
                headers: getHeaders()
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.description || data.error || 'Failed');
            $("webhookSecret").value = data.webhook_secret;
            showStatus('Secret regenerated');
        } catch (err) {
            showStatus(err.message, true);
        }
    }

    async function testWebhook() {
        try {
            const res = await fetch('/dashboard/api/webhooks/test', {
                method: 'POST',
                headers: getHeaders()
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.description || data.error || 'Failed');
            showStatus('Test webhook queued (log ' + data.webhook_log_id + ')');
            refreshLogs();
        } catch (err) {
            showStatus(err.message, true);
        }
    }

    async function refreshLogs() {
        const limit = parseInt($("limit").value || '10', 10);
        const offset = parseInt($("offset").value || '0', 10);
        try {
            const res = await fetch(`/api/v1/webhooks?limit=${limit}&offset=${offset}`, {
                headers: getHeaders()
            });
            const data = await res.json();
            const body = $("logsBody");
            body.innerHTML = '';
            if (!res.ok) throw new Error(data.description || data.error || 'Failed');
            const rows = (data.data || []);
            if (rows.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="muted">No logs</td></tr>';
                return;
            }
            rows.forEach(item => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-test-id', 'webhook-log-item');
                tr.setAttribute('data-webhook-id', item.id);
                const badgeClass = item.status === 'success' ? 'status-success' : item.status === 'failed' ? 'status-failed' : 'status-pending';
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.event}</td>
                    <td><span class="status-badge ${badgeClass}">${item.status}</span></td>
                    <td>${item.attempts ?? 0}</td>
                    <td class="muted small">${item.last_attempt_at || ''}</td>
                    <td class="actions">
                        <button type="button" data-id="${item.id}" class="retry-btn" data-test-id="retry-webhook-button" ${item.status !== 'failed' ? 'disabled' : ''}>Retry</button>
                    </td>`;
                body.appendChild(tr);
            });
            document.querySelectorAll('.retry-btn').forEach(btn => {
                btn.onclick = async () => {
                    const id = btn.getAttribute('data-id');
                    try {
                        const resp = await fetch(`/api/v1/webhooks/${id}/retry`, {
                            method: 'POST',
                            headers: getHeaders()
                        });
                        const payload = await resp.json();
                        if (!resp.ok) throw new Error(payload.description || payload.error || 'Retry failed');
                        showStatus('Retry queued for ' + id);
                        refreshLogs();
                    } catch (err) {
                        showStatus(err.message, true);
                    }
                };
            });
        } catch (err) {
            showStatus(err.message, true);
        }
    }

    $("saveConfig").onclick = saveConfig;
    $("regenSecret").onclick = regenerateSecret;
    $("testWebhook").onclick = testWebhook;
    $("refreshLogs").onclick = refreshLogs;
    $("copySecret").onclick = () => {
        navigator.clipboard.writeText($("webhookSecret").value || '').then(() => showStatus('Secret copied'));
    };
</script>
</body>
</html>
